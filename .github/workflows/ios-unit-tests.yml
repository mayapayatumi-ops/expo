name: iOS Unit Tests

on:
  workflow_dispatch: {}
  pull_request:
    paths:
      - .github/workflows/ios-unit-tests.yml
      - apps/expo-go/ios/**
      - packages/**/ios/**
      - apps/native-tests/ios/**
      - tools/src/dynamic-macros/**
      - tools/src/commands/IosGenerateDynamicMacros.ts
      - tools/src/commands/IosNativeUnitTests.ts
      - tools/src/commands/NativeUnitTests.ts
      - secrets/**
      - fastlane/**
      - Gemfile.lock
      - '!packages/@expo/cli/**'
  push:
    branches: [main]
    paths:
      - .github/workflows/ios-unit-tests.yml
      - apps/expo-go/ios/**
      - packages/**/ios/**
      - tools/src/dynamic-macros/**
      - tools/src/commands/IosGenerateDynamicMacros.ts
      - tools/src/commands/IosNativeUnitTests.ts
      - tools/src/commands/NativeUnitTests.ts
      - secrets/**
      - fastlane/**
      - Gemfile.lock
      - '!packages/@expo/cli/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 75
    steps:
      - name: üëÄ Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
      - name: üî® Switch to Xcode 26.0
        run: sudo xcode-select --switch /Applications/Xcode_26.0.app
      - name: ‚ûï Add `bin` to GITHUB_PATH
        run: echo "$(pwd)/bin" >> $GITHUB_PATH
      - name: üíé Setup Ruby and install gems
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
          ruby-version: 3.2.2
      - name: üßπ Cleanup unused simulator runtimes
        run: |
          xcrun simctl list devices -j | jq -r '.devices | to_entries[] | select(.key | contains("iOS") | not) | .value[].udid' | xargs -r -n1 xcrun simctl delete
          xcrun simctl list devices --json
          xcrun simctl erase all
          xcrun simctl shutdown all
          sudo xcodebuild -runFirstLaunch
      - name: üì± Pre-boot simulator
        timeout-minutes: 12
        run: |
          # NOTE: Keep simulator name in sync with fastlane/Fastfile unit_tests lane
          SIMULATOR="iPhone 17 Pro"
          DEVICE_ID=$(xcrun simctl list devices -j | jq -r '.devices | to_entries[] | .value[] | select(.name == "'"$SIMULATOR"'") | .udid' | head -n 1)

          for attempt in 1 2; do
            echo "Attempt $attempt: Booting $SIMULATOR $DEVICE_ID..."
            xcrun simctl shutdown "$DEVICE_ID" 2>/dev/null || true
            xcrun simctl boot "$DEVICE_ID" || true

            # Wait for boot with timeout
            if timeout 8m xcrun simctl bootstatus "$DEVICE_ID" -b 2>/dev/null; then
              echo "‚úì Simulator ready"
              xcrun simctl list devices | grep "$SIMULATOR"
              exit 0
            fi

            echo "‚úó Boot timeout, killing and retrying..."
            pkill -9 -f "CoreSimulator.*$DEVICE_ID" || true
            sleep 3
          done

          echo "Failed after 3 attempts"
          exit 1
      - name: ‚ôªÔ∏è Restore caches
        uses: ./.github/actions/expo-caches
        id: expo-caches
        with:
          yarn-workspace: 'true'
          yarn-tools: 'true'
          native-tests-pods: 'true'
      - name: üß∂ Yarn install
        if: steps.expo-caches.outputs.yarn-workspace-hit != 'true'
        run: yarn install --frozen-lockfile
      - name: ü•• Install CocoaPods in `apps/native-tests/ios`
        if: steps.expo-caches.outputs.bare-expo-pods-hit != 'true'
        run: pod install
        env:
          RCT_USE_PREBUILT_RNCORE: 1
          RCT_USE_RN_DEP: 1
        working-directory: apps/native-tests/ios
      - name: üß™ Run native iOS unit tests
        timeout-minutes: 30
        env:
          FASTLANE_SKIP_UPDATE_CHECK: '1'
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 30
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 8
        run: expotools native-unit-tests --platform ios
